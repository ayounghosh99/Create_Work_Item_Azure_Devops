import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Menu.css";import"./MenuButton.css";import*as React from"react";import{ObservableLike,ObservableValue}from"../../Core/Observable";import{Callout}from"../../Callout";import{Checkbox}from"../../Checkbox";import{FocusWithin}from"../../FocusWithin";import{FocusZone,FocusZoneContext,FocusZoneDirection,FocusZoneKeyStroke}from"../../FocusZone";import{Icon,IconSize}from"../../Icon";import{List}from"../../List";import{MouseWithin}from"../../MouseWithin";import{Observer}from"../../Observer";import{Tooltip}from"../../TooltipEx";import{css,getSafeId,getSafeIdSelector,isArrowKey,KeyCode,preventDefault,setFocusVisible}from"../../Util";import{Location}from"../../Utilities/Position";import{ArrayItemProvider}from"../../Utilities/Provider";import{MenuCell,MenuItemType}from"./Menu.Props";export function groupMenuItems(e,t){var n={},o=0,r=[],i=t||[];if(i.length>0){o=i.reduce(function(e,t){return t.rank||0>e?t.rank:e},0)||0;for(var a=0,s=i;a<s.length;a++){f=s[a];n[f.key]={key:f.key,rank:void 0===f.rank?++o:f.rank,items:[]}}}for(var l=0,c=e;l<c.length;l++){var u=c[l];u.groupKey?n[u.groupKey]?n[u.groupKey].items.push(u):n[u.groupKey]={key:u.groupKey,rank:++o,items:[u]}:r.push(u)}var m=Object.keys(n).map(function(e){return n[e]});m.sort(function(e,t){return(e.rank||Number.MAX_VALUE)-(t.rank||Number.MAX_VALUE)}),m.push({key:"ungrouped",rank:++o,items:r}),m.forEach(function(e){for(var t=e.items;t.length>0&&t[0].itemType===MenuItemType.Divider;)t.shift();for(;t.length>0&&t[t.length-1].itemType===MenuItemType.Divider;)t.pop()}),e=[];for(var p=!0,d=0,v=m;d<v.length;d++){var f;0!==(f=v[d]).items.length&&(p||e.push({id:"divider_"+f.key,itemType:MenuItemType.Divider}),p&&(p=!1),e=e.concat(f.items))}return e};var MenuItemProvider=function(e){function t(t,n){var o=e.call(this,t)||this;o.positions=[];var r=[];if(t){for(var i=!1,a=!1,s=MenuItemType.Divider,l=void 0,c=0,u=t;c<u.length;c++){var m=u[c];if(m.itemType===MenuItemType.Divider){if(m.itemType===s)continue;l=m}else l&&(r.push(l),l=void 0),r.push(m);s=m.itemType||MenuItemType.Normal,i=!!m.groupKey||i,a=m.rank>=0||a}a&&r.sort(function(e,t){return(e.rank||Number.MAX_VALUE)-(t.rank||Number.MAX_VALUE)}),i&&(r=groupMenuItems(r,n))}return o.items=r,o}return __extends(t,e),t.prototype.getCount=function(){if(void 0===this.count){this.count=0;for(var e=0,t=this.items;e<t.length;e++){var n=t[e];n.itemType===MenuItemType.Divider||n.itemType===MenuItemType.Header?this.positions.push(-1):this.positions.push(++this.count)}}return this.count},t.prototype.getItem=function(e){return this.items[e]},t.prototype.getPosition=function(e){return this.positions.length||this.getCount(),this.positions[e]},t}(ArrayItemProvider),Menu=function(e){function t(t){var n=e.call(this,t)||this;return n.containerElement=React.createRef(),n.expandItem=function(e,t){if(e||-1===n.state.expandedIndex.value||(e=n.itemProvider.getItem(n.state.expandedIndex.value)),e&&e.subMenuProps)for(var o=0;o<n.itemProvider.length;o++)if(e===n.itemProvider.getItem(o)){n.state.expandedIndex.value=t?o:-1;break}},n.focus=function(){n.containerElement.current&&n.containerElement.current.focus()},n.getParent=function(){return n.props.parentMenu},n.onActivate=function(e,t){n.props.onActivate&&n.props.onActivate(e,t)},n.renderMenuItem=function(e,t,o){var r=o.onFocusItem,i={expandedIndex:n.state.expandedIndex,menu:n,menuProps:n.props,onActivate:n.onActivate,onFocusItem:r,position:n.itemProvider.getPosition(e),setSize:n.itemProvider.getCount()};if(t.renderMenuItem)return t.renderMenuItem(e,t,i);var a=t.id;switch(t.itemType){case MenuItemType.Divider:return MenuDivider(e,t);case MenuItemType.Header:return MenuHeader(e,t);default:return React.createElement(MenuItem,{key:a,index:e,menuItem:t,details:i})}},n.state={expandedIndex:new ObservableValue(-1)},n}return __extends(t,e),t.prototype.render=function(){var e=this;return React.createElement(Observer,{items:this.props.items},function(t){return e.itemProvider=new MenuItemProvider(t.items,e.props.groups),e.renderList()})},t.prototype.renderList=function(){return React.createElement("div",{className:"bolt-menu-container no-outline",ref:this.containerElement,tabIndex:-1},this.itemProvider.length>0&&React.createElement(React.Fragment,null,React.createElement("div",{className:"bolt-menu-spacer",onMouseDown:preventDefault}),React.createElement(List,{ariaLabel:this.props.ariaLabel,className:css(this.props.className,"bolt-menu"),columnCount:7,focuszoneProps:null,id:this.props.id,itemProvider:this.itemProvider,renderRow:this.renderMenuItem,role:"menu",virtualize:!1}),React.createElement("div",{className:"bolt-menu-spacer",onMouseDown:preventDefault})))},t}(React.Component);export{Menu};export function MenuDivider(e,t){return React.createElement("tr",{"aria-hidden":"true",className:css(t.className,"bolt-menuitem-row bolt-list-row bolt-menuitem-divider"),key:t.id||"divider-"+e,onMouseDown:preventDefault},React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell"}),React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell bolt-menuitem-divider-column",colSpan:5},React.createElement("div",{className:"bolt-menuitem-divider-content"})),React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell"}))};export function MenuHeader(e,t){return React.createElement("tr",{"aria-level":1,className:css(t.className,"bolt-menuitem-row bolt-list-row bolt-menuitem-header"),key:t.id||"header-"+e,onMouseDown:preventDefault,role:"heading"},React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell"}),React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell",colSpan:3},React.createElement("div",{className:"bolt-menuitem-cell-content bolt-menuitem-cell-text"},t.text)),React.createElement("td",{className:"bolt-menuitem-cell bolt-list-cell",colSpan:3}))};var MenuItem=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.localKeyStroke=!1,t.expanded=!1,t.element=React.createRef(),t.handleClick=function(e){var n=t.props.menuItem;if(n.disabled)e.preventDefault();else if(!t.expanded){var o=void 0;n.onActivate&&(o=n.onActivate(n,e)),o||(n.href||e.preventDefault(),n.subMenuProps?t.props.details.menu.expandItem(n,!0):n.href?t.props.details.onActivate(n,e):(void 0===n.checked||n.readonly)&&t.props.details.onActivate(n,e))}},t.onClick=function(e){e.defaultPrevented||t.handleClick(e)},t.onDismissSubMenu=function(e){!e&&t.element.current&&t.props.details.menu.expandItem(t.props.menuItem,!1)},t.onExpandedChange=function(e){return t.expanded&&e!==t.props.index||!t.expanded&&e===t.props.index},t.onFocus=function(e){t.element.current===document.activeElement&&t.props.details.onFocusItem(t.props.index,e)},t.onKeyDown=function(e){if(t.localKeyStroke=!0,!e.defaultPrevented){var n=t.props.menuItem;e.which===KeyCode.tab||e.which===KeyCode.space?e.preventDefault():e.which===KeyCode.rightArrow&&n.subMenuProps&&(e.preventDefault(),t.props.details.menu.expandItem(n,!0))}},t.onKeyUp=function(e){t.localKeyStroke&&(e.defaultPrevented||e.which!==KeyCode.enter&&e.which!==KeyCode.space||t.handleClick(e))},t.onMouseDown=function(e){if(!e.defaultPrevented){(t.props.menuItem.disabled||t.props.details.expandedIndex.value===t.props.index)&&e.preventDefault()}},t.onMouseEnter=function(){t.props.menuItem.disabled||(t.props.details.menu.expandItem(t.props.menuItem,!0),setFocusVisible(!1))},t.onMouseLeave=function(){t.onDismissSubMenu(!1)},t}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.index,o=t.menuItem,r=t.details,i=r.menu,a=r.position,s=r.setSize,l=o.checked,c=o.className,u=o.disabled,m=o.href,p=o.iconProps,d=o.readonly,v=o.secondaryText,f=o.subMenuProps,h=o.target,b=o.id,M=o.rel,x=o.text,y=m?"div":"td",I=m?"a":"tr";return m&&h&&!M&&(M="noopener"),React.createElement(Observer,{checked:l,expandedIndex:{observableValue:this.props.details.expandedIndex,filter:this.onExpandedChange}},function(t){return e.expanded=t.expandedIndex===n,React.createElement(MouseWithin,{enterDelay:250,leaveDelay:250,onMouseEnter:e.onMouseEnter,onMouseLeave:e.onMouseLeave},function(n){return React.createElement(FocusZoneContext.Consumer,null,function(l){return React.createElement(FocusWithin,{onFocus:e.onFocus},function(E){return React.createElement(FocusZone,{direction:FocusZoneDirection.Horizontal},React.createElement(I,{"aria-checked":!0===t.checked||void 0,"aria-controls":e.expanded&&f?getSafeId(f.id):void 0,"aria-disabled":u?"true":void 0,"aria-expanded":f?e.expanded:void 0,"aria-haspopup":!!f||void 0,"aria-posinset":a,"aria-setsize":s,className:css(c,"bolt-menuitem-row bolt-list-row bolt-menuitem-row-normal cursor-pointer",u&&"disabled",e.expanded&&"expanded",E.hasFocus&&"focused"),"data-focuszone":u?void 0:l.focuszoneId,href:m,id:getSafeId(b),role:void 0!==t.checked?"menuitemcheckbox":"menuitem",onBlur:E.onBlur,onClick:e.onClick,onFocus:E.onFocus,onKeyDown:e.onKeyDown,onKeyUp:e.onKeyUp,onMouseDown:e.onMouseDown,onMouseEnter:n.onMouseEnter,onMouseLeave:n.onMouseLeave,ref:e.element,rel:M,tabIndex:u?void 0:-1,target:h},React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},React.createElement("div",{className:"bolt-menuitem-cell-content flex-row"})),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},void 0!==t.checked&&(o.renderMenuCell&&o.renderMenuCell(MenuCell.State,o,r)||React.createElement("div",{className:"bolt-menuitem-cell-content bolt-menuitem-cell-state flex-row"},!0===d?Icon({className:css(!t.checked&&"invisible"),iconName:"CheckMark"}):React.createElement(Checkbox,{checked:t.checked,disabled:u,excludeFocusZone:!0,excludeTabStop:!0,onChange:e.onClick})))),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},o.renderMenuCell&&o.renderMenuCell(MenuCell.Icon,o,r)||p&&React.createElement("div",{className:"bolt-menuitem-cell-content bolt-menuitem-cell-icon flex-row"},Icon(p))),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},o.renderMenuCell&&o.renderMenuCell(MenuCell.PrimaryText,o,r)||React.createElement("div",{id:getSafeId(b+"-text"),className:"bolt-menuitem-cell-content bolt-menuitem-cell-text flex-row"},x?React.createElement(Tooltip,{overflowOnly:!0,text:x},React.createElement("div",{className:"text-ellipsis"},x)):React.createElement("div",null," "))),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},o.renderMenuCell&&o.renderMenuCell(MenuCell.SecondaryText,o,r)||v&&React.createElement("div",{className:"bolt-menuitem-cell-content bolt-menuitem-cell-secondary flex-row"},v)),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},o.renderMenuCell&&o.renderMenuCell(MenuCell.Action,o,r)||f&&React.createElement("div",{className:"bolt-menuitem-cell-content bolt-menuitem-cell-submenu flex-row"},Icon({iconName:"ChevronRightMed",size:IconSize.small}),e.expanded&&e.element.current&&React.createElement(ContextualMenu,{anchorElement:e.element.current,anchorOffset:{horizontal:0,vertical:-8},anchorOrigin:{horizontal:Location.end,vertical:Location.start},subMenu:!0,menuOrigin:{horizontal:Location.start,vertical:Location.start},menuProps:f,onActivate:e.props.details.onActivate,onDismiss:e.onDismissSubMenu,parentMenu:i}))),React.createElement(y,{className:"bolt-menuitem-cell bolt-list-cell"},React.createElement("div",{className:"bolt-menuitem-cell-content flex-row"}))))})})})})},t}(React.Component);export{MenuItem};var ContextualMenu=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onDismiss=function(){t.props.onDismiss&&t.props.onDismiss(!1)},t.onKeyDown=function(e){e.defaultPrevented||(e.which===KeyCode.escape||e.which===KeyCode.tab||e.which===KeyCode.leftArrow&&t.props.subMenu)&&(e.preventDefault(),t.props.onDismiss&&t.props.onDismiss(!1))},t.onActivate=function(e,n){t.props.menuProps.onActivate&&t.props.menuProps.onActivate(e,n),t.props.onActivate&&t.props.onActivate(e,n),t.props.onDismiss&&t.props.onDismiss(!0)},t.preprocessKeyStroke=function(e){return isArrowKey(e)?FocusZoneKeyStroke.IgnoreParents:FocusZoneKeyStroke.IgnoreNone},t}return __extends(t,e),t.prototype.render=function(){for(var e=".bolt-menu-container",t=ObservableLike.getValue(this.props.menuProps.items),n=0;n<t.length;n++)if(t[n].itemType===MenuItemType.Normal||void 0===t[n].itemType){var o=t[n].id;if(!o||t[n].disabled)continue;e=getSafeIdSelector(o);break}return React.createElement(Callout,{anchorElement:this.props.anchorElement,anchorOffset:this.props.anchorOffset,anchorOrigin:this.props.anchorOrigin,anchorPoint:this.props.anchorPoint,blurDismiss:!0,calloutOrigin:this.props.menuOrigin,className:this.props.className,contentClassName:css("bolt-contextual-menu flex-column custom-scrollbar depth-8",this.props.subMenu&&"bolt-contextual-submenu"),contentShadow:!0,onDismiss:this.onDismiss,fixedLayout:this.props.fixedLayout,focuszoneProps:{defaultActiveElement:e,direction:FocusZoneDirection.Vertical,focusOnMount:!0,preprocessKeyStroke:this.preprocessKeyStroke},id:this.props.menuProps.id+"-callout",portalProps:{className:"bolt-menu-portal"}},React.createElement("div",{className:"bolt-contextualmenu-container",onKeyDown:this.onKeyDown},React.createElement(Menu,__assign({},this.props.menuProps,{onActivate:this.onActivate,parentMenu:this.props.parentMenu}))))},t}(React.Component);export{ContextualMenu};