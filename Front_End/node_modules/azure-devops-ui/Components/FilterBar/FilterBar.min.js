import{__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./FilterBar.css";import*as React from"react";import*as Utils_Accessibility from"../../Core/Util/Accessibility";import{format}from"../../Core/Util/String";import{Button}from"../../Button";import*as Resources from"../../Resources.FilterBar";import{SurfaceBackground,SurfaceContext}from"../../Surface";import{css,getSafeId}from"../../Util";import{FILTER_APPLIED_EVENT,FILTER_CHANGE_EVENT}from"../../Utilities/Filter";var idCount=0,FilterBar=function(e){function t(s){var i=e.call(this,s)||this;if(i._firstChildIsKeywordItem=!1,i._prevContainerWidth=0,i._id=getSafeId("filter-bar-"+idCount++),i._onResize=function(){i._resizeTimeout||(i._resizeTimeout=setTimeout(function(){if(i._resizeTimeout=null,i._isMounted){var e=i._prevContainerWidth<i._filterBarElement.clientWidth,s=(!i.state.shouldHidePlaceholderLabels||!e)&&i.state.shouldHidePlaceholderLabels,r=(!i.state.shouldHaveMaxItemWidth||!e)&&i.state.shouldHaveMaxItemWidth;i.setState({filtersToShowStopIndex:t.RENDER_EVERYTHING,shouldHidePlaceholderLabels:s,shouldHaveMaxItemWidth:r}),i._prevContainerWidth=i._filterBarElement.clientWidth}},100))},i._onPageLeft=function(){i._hasMadeVisibleFilterAnnouncement=!1;var e=i._startingFilterIndices.pop()||0;i._hasPagedLeft=!0,i.setState({filtersToShowStartIndex:e,filtersToShowStopIndex:t.RENDER_EVERYTHING})},i._onPageRight=function(){i._hasMadeVisibleFilterAnnouncement=!1,i._startingFilterIndices.push(i.state.filtersToShowStartIndex),i._hasPagedRight=!0,i.setState({filtersToShowStartIndex:i.state.filtersToShowStopIndex,filtersToShowStopIndex:t.RENDER_EVERYTHING})},i._calculateFiltersToShowStopIndex=function(){for(var e=i._rightElement.clientWidth,t=0;t<i._childrenContainerElements.length;t++){var s=i._childrenContainerElements[t];if((e+=s.clientWidth+parseFloat(window.getComputedStyle(s).marginRight))>i._filterBarElement.clientWidth){var r=i.state.filtersToShowStartIndex+t;return r>i.state.filtersToShowStartIndex?r:i.state.filtersToShowStartIndex+1}}return i.state.filtersToShowStartIndex+i._childrenContainerElements.length},i._onFilterChanged=function(e){i.setState({hasChangesToApply:i.props.filter.hasChangesToApply(),hasChangesToReset:i.props.filter.hasChangesToReset(),filtersToShowStopIndex:t.RENDER_EVERYTHING,shouldHidePlaceholderLabels:!1})},i._onFilterApplied=function(e){i.setState({hasChangesToApply:i.props.filter.hasChangesToApply()})},i._onClearAndDismiss=function(){i.props.filter.hasChangesToReset()&&i.props.filter.reset(),i.props.onDismissClicked&&i.props.onDismissClicked()},i._onApplyChanges=function(){i.props.filter.applyChanges(),i.focus()},!s.filter)throw new Error("Cannot create a FilterBar without a filter prop.");return i._startingFilterIndices=[],i._hasMadeVisibleFilterAnnouncement=!1,i._isMounted=!1,i.state={hasChangesToReset:s.filter.hasChangesToReset(),hasChangesToApply:s.filter.hasChangesToApply(),filtersToShowStartIndex:0,filtersToShowStopIndex:t.RENDER_EVERYTHING,shouldHidePlaceholderLabels:!1,shouldHaveMaxItemWidth:!1},i}return __extends(t,e),t.prototype.focus=function(){this._filterItemRefs&&this._filterItemRefs.length>0&&this._filterItemRefs[0].focus()},t.prototype.forceUpdate=function(){e.prototype.forceUpdate.call(this),this._filterItemRefs&&this._filterItemRefs.forEach(function(e){return e.forceUpdate()})},t.prototype.componentDidMount=function(){this.props.filter&&this.props.filter.subscribe(this._onFilterChanged,FILTER_CHANGE_EVENT),this.props.filter&&this.props.filter.subscribe(this._onFilterApplied,FILTER_APPLIED_EVENT),window.addEventListener("resize",this._onResize);var e=this._calculateFiltersToShowStopIndex();e<React.Children.toArray(this.props.children).length-1?this.setState({shouldHidePlaceholderLabels:!0}):this.setState({filtersToShowStopIndex:e}),this._isMounted=!0,this.props.onMounted&&this.props.onMounted(this)},t.prototype.UNSAFE_componentWillReceiveProps=function(e){this.getChildKeysAsString(this.props)!==this.getChildKeysAsString(e)?this.setState({hasChangesToApply:e.filter.hasChangesToApply(),hasChangesToReset:e.filter.hasChangesToReset(),filtersToShowStartIndex:0,filtersToShowStopIndex:t.RENDER_EVERYTHING}):this.setState({hasChangesToApply:e.filter.hasChangesToApply(),hasChangesToReset:e.filter.hasChangesToReset()})},t.prototype.componentWillUnmount=function(){this.props.filter&&this.props.filter.unsubscribe(this._onFilterChanged,FILTER_CHANGE_EVENT),this.props.filter&&this.props.filter.unsubscribe(this._onFilterApplied,FILTER_APPLIED_EVENT),window.removeEventListener("resize",this._onResize),this._isMounted=!1},t.prototype.componentDidUpdate=function(){if(this.props.onRenderComplete&&this.props.onRenderComplete(),this._hasPagedLeft&&this.state.filtersToShowStopIndex>0&&(0==this.state.filtersToShowStartIndex&&this._nextButtonElem&&this._nextButtonElem.focus(),this._hasPagedLeft=!1),this.state.filtersToShowStopIndex<0){var e=this._calculateFiltersToShowStopIndex(),t=e===React.Children.toArray(this.props.children).length;t||this.state.shouldHidePlaceholderLabels?t||this.state.shouldHaveMaxItemWidth?(this._hasPagedRight&&e===this.state.filtersToShowStartIndex+this._childrenContainerElements.length&&this._prevButtonElem&&this._prevButtonElem.focus(),this.setState({filtersToShowStopIndex:e}),this._hasPagedRight=!1):this.setState({shouldHaveMaxItemWidth:!0}):this.setState({shouldHidePlaceholderLabels:!0})}else this._hasMadeVisibleFilterAnnouncement||(Utils_Accessibility.announce(format(Resources.AnnonuceVisibleFilters,this.state.filtersToShowStartIndex+1,this.state.filtersToShowStopIndex),!1),this._hasMadeVisibleFilterAnnouncement=!0)},t.prototype.render=function(){var e=this,t=this.props,s=t.children,i=t.filter,r=t.className,o=t.onDismissClicked,n=this.state,a=n.hasChangesToApply,l=n.hasChangesToReset,h=n.filtersToShowStopIndex,c=n.filtersToShowStartIndex,d=n.shouldHaveMaxItemWidth,p=n.shouldHidePlaceholderLabels;this._filterItemRefs=[],this._childrenContainerElements=[];var f=!0,u=!1;this._firstChildIsKeywordItem=!1;var m=React.Children.map(s,function(t){if(null===t)return null;var s="vss-FilterBar--item",r=t;r.props.isTextItem&&!u?(e._firstChildIsKeywordItem=f,u=!0,s=css(s,"vss-FilterBar--item-keyword-container")):d&&(s=css(s,"max-width-small")),f=!1;var o=React.cloneElement(r,{filter:r.props.filter||i,ref:function(t){t&&e._filterItemRefs.push(t)},hideSelectedItemIcon:!0,showPlaceholderAsLabel:!p&&r.props.showPlaceholderAsLabel});return React.createElement("div",{className:s,ref:function(t){t&&e._childrenContainerElements.push(t)}},o)}),_=h<m.length,E=c>0;if(_||E){var R=h>0?h:m.length;m=m.slice(c,R)}var S=o?Resources.ClearAndDismissFilterBarLinkLabel:Resources.ClearFilterBarLinkLabel;return React.createElement(SurfaceContext.Consumer,null,function(t){return React.createElement("div",{className:css(r,"vss-FilterBar",t.background===SurfaceBackground.neutral&&"bolt-filterbar-white depth-8 no-v-margin"),role:"search",id:e._id},React.createElement("div",{className:css("vss-FilterBar--list",(!e._firstChildIsKeywordItem||c>0)&&"justify-right"),ref:function(t){e._filterBarElement=t}},m,React.createElement("div",{className:"vss-FilterBar--right-items",ref:function(t){e._rightElement=t}},(E||_)&&React.createElement("div",{className:"vss-FilterBar--page-button-container"},React.createElement(Button,{className:"filter-bar-button  vss-FilterBar-page-button",ref:function(t){e._prevButtonElem=t},onClick:e._onPageLeft,disabled:!E,ariaLabel:Resources.FilterPageLeftAriaLabel,iconProps:{iconName:"ChevronLeftMed"}}),React.createElement(Button,{className:"filter-bar-button vss-FilterBar-page-button",ref:function(t){e._nextButtonElem=t},onClick:e._onPageRight,disabled:!_,ariaLabel:Resources.FilterPageRightAriaLabel,iconProps:{iconName:"ChevronRightMed"}})),!e.props.hideClearAction&&React.createElement("div",{className:"vss-FilterBar--action vss-FilterBar--action-clear"},React.createElement(Button,{ariaLabel:S,className:"filter-bar-button",disabled:!l&&!o,iconProps:{iconName:"Cancel"},onClick:e._onClearAndDismiss,subtle:!0,tooltipProps:{text:S}})),i.usesApplyMode()&&React.createElement("div",{className:"vss-FilterBar--action vss-FilterBar--action-apply"},React.createElement(Button,{className:"filter-bar-button",disabled:!a,onClick:e._onApplyChanges,iconProps:{iconName:"CheckMark"}},Resources.ApplyChangesFilterBarText)))))})},t.prototype.getChildKeysAsString=function(e){var t=e.children&&React.Children.map(e.children,function(e){if(null===e)return null;return void 0===e?"":e.props.filterItemKey})||[];return JSON.stringify(t)},t.RENDER_EVERYTHING=-1,t}(React.Component);export{FilterBar};