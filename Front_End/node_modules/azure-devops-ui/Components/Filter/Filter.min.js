import{__assign,__extends,__spreadArrays}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./Filter.css";import*as React from"react";import{ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{announce}from"../../Core/Util/Accessibility";import{ScreenSize}from"../../Core/Util/Screen";import{format}from"../../Core/Util/String";import{Button}from"../../Button";import{ContentLocation}from"../../Callout";import{Dropdown,DropdownCalloutComponent,DropdownExpandableButton,filterItems}from"../../Dropdown";import{FocusZoneContext}from"../../FocusZone";import{Icon}from"../../Icon";import{renderListCell}from"../../List";import{getListBoxItemsValue,ListBox,ListBoxItemType,wrapListBoxItems}from"../../ListBox";import{Observer,SelectionObserver}from"../../Observer";import{Pill,PillSize}from"../../Pill";import*as Resources from"../../Resources.Filter";import{TextField}from"../../TextField";import{css,KeyCode}from"../../Util";import{updateFilterToSelection}from"../../Utilities/DropdownFilter";import{DropdownMultiSelection}from"../../Utilities/DropdownSelection";import{FILTER_CHANGE_EVENT}from"../../Utilities/Filter";import{Location}from"../../Utilities/Position";import{ScreenSizeObserver}from"../../Utilities/ScreenSize";import{compareSelectionRanges,indexWithinRanges}from"../../Utilities/Selection";import*as Utils_Accessibility from"../../Core/Util/Accessibility";var FilterCalloutWidth=320,FilterItemPadding=48,Filter=function(e){function t(t){var r=e.call(this,t)||this;return r.dropdown=React.createRef(),r.dropdownCallout=React.createRef(),r.filterText=new ObservableValue(""),r.timerManagement=new TimerManagement,r.collapse=function(){r.dropdown.current&&r.dropdown.current.collapse()},r.expand=function(){r.dropdown.current&&r.dropdown.current.expand()},r.onDoneClick=function(){var e=r.props.filterStore;e.usesApplyMode()&&e.applyChanges(),r.collapse()},r.onApplyClick=function(){var e=r.props.filterStore;e.usesApplyMode()&&e.applyChanges(),r.clearActiveFilter()},r.onExpandClick=function(){Utils_Accessibility.announce(r.props.title||Resources.FilterTitle)},r.renderBeforeContent=function(){return React.createElement(Observer,{activeFilter:r.activeFilter,filterText:r.filterText,bestHitItem:r.props.bestHitItem,userFilteredItems:r.props.userFilteredItems},function(e){return e.activeFilter?e.activeFilter.renderBeforeContent?e.activeFilter.renderBeforeContent(r.clearActiveFilter):null:e.filterText?r.renderFilteredView():r.renderFilterItems()})},r.renderFilteredView=function(){var e=[];r.props.bestHitItem&&r.props.bestHitItem.value&&(e.push({id:"best-hit-header",text:Resources.BestHit,type:ListBoxItemType.Header,className:"bolt-filtered-header"}),e.push(r.props.bestHitItem.value)),r.props.userFilteredItems?e.push.apply(e,getListBoxItemsValue(r.props.userFilteredItems)):(r.props.filterItems.forEach(function(t){var i=filterItems(getListBoxItemsValue(t.items),r.filterText.value||"").filteredItems,o=r.getSelectedFilterItems(t);(i=i.filter(function(e){return e.type!==ListBoxItemType.Header&&e.type!==ListBoxItemType.Divider&&-1===o.indexOf(e)&&(!r.props.bestHitItem||r.props.bestHitItem.value!==e)})).length&&(e.push({id:t.id,text:t.name,type:ListBoxItemType.Header,className:"bolt-filtered-header"}),e.push.apply(e,i.map(function(e){return __assign(__assign({},e),{groupId:t.id})})))}),r.props.filterItems.some(function(e){return"keyword-item"===e.id})&&e.push.apply(e,getKeywordSearchResults(r.filterText.value)));var t=e.filter(function(e){return e.type!==ListBoxItemType.Header}).length;return t>0?r.announceWithDebouncing(format(Resources.AnnounceFilterResultCount,t)):r.announceWithDebouncing(Resources.NoFilterResults),React.createElement(ListBox,{items:e,onSelect:r.onFilteredItemSelect,onActivate:r.onFilteredItemSelect,excludeTabStop:!0,focuszoneProps:null})},r.renderSelectedItems=function(e,t){return!1!==r.props.showFilterOnText&&r.filtered()?Resources.FilterOn:Resources.Filter},r.renderFilterItems=function(){var e=r.props,t=e.filterItems,i=e.filterStore;return React.createElement(FocusZoneContext.Consumer,null,function(e){return t.map(function(t,o){var l=r.getSelectedFilterItems(t),n=l.length,a=i.getFilterItemState(t.filterItemKey),s=i.getDefaultState()[t.filterItemKey],c=i.filterItemStatesAreEqual(t.filterItemKey,a,s);return React.createElement("div",{className:"flex-row flex-center bolt-filter-item",key:t.id,id:"bolt-filter-item-"+t.id,"data-focuszone":e.focuszoneId,tabIndex:-1,onClick:function(){return r.onFilterItemSelected(t)},onKeyDown:function(e){e.defaultPrevented||e.which!==KeyCode.enter&&e.which!==KeyCode.space&&e.which!==KeyCode.rightArrow||(r.onFilterItemSelected(t,e.currentTarget),e.preventDefault())}},React.createElement("div",{className:css("flex-row flex-center flex-grow bolt-filter-label",a&&a.value&&0!==a.value.length&&"bolt-filter-label-selected"),style:{width:r.props.width-FilterItemPadding}},React.createElement("span",{className:css(c&&"secondary-text",!c&&"font-weight-semibold")},t.name),n>1&&React.createElement(Pill,{className:"bolt-filter-selection-pill",excludeFocusZone:!0,size:PillSize.compact},n),React.createElement("div",{className:"flex-grow flex-row bolt-filter-selected-item-container"},t.renderSelectedItems?t.renderSelectedItems(l):renderSelectedFilterItems(l))),React.createElement(Icon,{iconName:"ChevronRight"}))})})},r.onFilteredItemSelect=function(e,t){if(t.groupId){var i=r.props.filterStore,o=r.props.filterItems.find(function(e){return e.id===t.groupId});if(o){var l=o.filterItemKey,n=i.getFilterItemState(l),a=void 0!==t.data?t.data:t.id;"keyword"===l?i.setFilterItemState(l,{value:t.id}):n&&n.value&&Array.isArray(n.value)&&r.selection.multiSelect?i.setFilterItemState(t.groupId,{value:__spreadArrays(n.value,[a])}):i.setFilterItemState(l,{value:[a]})}}r.filterText.value="",r.dropdownCallout.current&&r.dropdownCallout.current.focus()},r.onFilterChanged=function(e){var t=r.props.filterStore.getState(),i=new DropdownMultiSelection,o=getListBoxItemsValue(r.wrappedItems||r.props.items),l=function(e){var r=t[e];if(r&&r.value)if("keyword"===e){var l=o.findIndex(function(e){return e.id===r.value});l>-1&&i.select(l,1,!0)}else for(var n=function(e){var t=o.findIndex(function(t){return t.id===r.value[e]||t.data===r.value[e]});t>-1&&i.select(t,1,!0)},a=0;a<r.value.length;a++)n(a)};for(var n in t)l(n);compareSelectionRanges(r.selection.value,i.value).length&&(r.selection.value=i.value)},r.onSelectionChanged=function(e){var t=getListBoxItemsValue(r.wrappedItems||r.props.items);if(r.props.filterStore&&r.activeFilter.value){for(var i=new DropdownMultiSelection,o=0,l=0;r.props.filterItems[l].id!==r.activeFilter.value.id;l++)o+=r.props.filterItems[l].items.length;if(e.forEach(function(e){for(var t=e.beginIndex;t<=e.endIndex;t++)t>=o&&t<o+r.activeFilter.value.items.length&&i.select(t,1,!0)}),"keyword"===r.activeFilter.value.filterItemKey&&0===i.value.length)return!0;updateFilterToSelection(i.value,t,r.props.filterStore,r.activeFilter.value.filterItemKey)}return!0},r.onResetClick=function(){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.filterStore.reset()},r.onResetFilterItemClick=function(e){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.filterStore.resetFilterItemState(e)},r.onFilterItemSelected=function(e,t){r.dropdownCallout.current&&r.dropdownCallout.current.focus(),r.props.activeFilter||(r.activeFilter.value=e,announce(format(Resources.FilterSelected,e.name)),r.activeFilterReturnElementId=null===t||void 0===t?void 0:t.id),r.props.onActiveFilterChanged&&r.props.onActiveFilterChanged(e)},r.getOnFilterTextChanged=function(e){return function(t,i){r.filterText.value=i,r.activeFilter.value&&e.onFilterTextChanged&&(e.onFilterTextChanged(t,i),r.dropdownOnFilterTextChanged=e.onFilterTextChanged),r.props.onFilterTextChanged&&r.props.onFilterTextChanged(t,i)}},r.getFilterStartingIndex=function(e){if(e){for(var t=r.props.filterItems.indexOf(e),i=0,o=0;o<t;o++)i+=r.props.filterItems[o].items.length;return i}return-1},r.getSelectedFilterItems=function(e){for(var t=[],i=getListBoxItemsValue(r.wrappedItems||r.props.items),o=r.getFilterStartingIndex(e),l=o;l<o+e.items.length;l++)indexWithinRanges(l,r.selection.value)&&t.push(i[l]);return t},r.clearFilterSelection=function(){r.activeFilter.value&&r.props.filterStore.setFilterItemState(r.activeFilter.value.filterItemKey,{value:null})},r.clearActiveFilter=function(){r.dropdownCallout.current&&(r.dropdownCallout.current.focus(),requestAnimationFrame(function(){if(r.activeFilterReturnElementId){var e=document.getElementById(r.activeFilterReturnElementId);null===e||void 0===e||e.focus(),r.activeFilterReturnElementId=void 0}})),r.props.activeFilter||(r.activeFilter.value=null),r.props.onActiveFilterChanged&&r.props.onActiveFilterChanged(null),r.filterText.value="",r.dropdownOnFilterTextChanged&&r.dropdownOnFilterTextChanged(null,"")},r.filtered=function(){var e=r.props.filterStore.getAppliedState();for(var t in e)if(e[t].value&&(!Array.isArray(e[t].value)||e[t].value.length>0))return!0;return!1},r.announceWithDebouncing=function(e){Utils_Accessibility.announce(e,!1,300)},r.state={},r.selection=t.selection||new DropdownMultiSelection,r.wrappedItems=wrapListBoxItems(t.items),r.activeFilter=t.activeFilter||new ObservableValue(null),r}return __extends(t,e),t.prototype.focus=function(){this.dropdown.current&&this.dropdown.current.focus()},t.prototype.componentDidMount=function(){this.props.filterStore&&this.props.filterStore.subscribe(this.onFilterChanged,FILTER_CHANGE_EVENT),this.onFilterChanged(this.props.filterStore.getState()),this.announceWithDebouncing=this.timerManagement.debounce(this.announceWithDebouncing,300)},t.prototype.componentWillUnmount=function(){this.props.filterStore&&this.props.filterStore.unsubscribe(this.onFilterChanged,FILTER_CHANGE_EVENT)},t.prototype.render=function(){var e=this,t=this.props,r=t.filterStore,i=t.showActiveFilterResetButton,o=!1!==t.showFilterOnText&&this.filtered();return React.createElement(Observer,{activeFilter:this.activeFilter,filter:r},React.createElement(SelectionObserver,{selection:this.selection,onSelectionChanged:this.onSelectionChanged},function(){var t=e.activeFilter.value,l=[],n=0,a={className:"bolt-filter-reset-button",text:t?Resources.Reset:Resources.ResetAll,subtle:!1,onClick:t?function(){return e.onResetFilterItemClick(t.filterItemKey)}:e.onResetClick,id:"filter-reset-button"};if(t){var s=r.getFilterItemState(t.filterItemKey);n=e.getSelectedFilterItems(t).length,i?r.hasChangesToReset()&&l.push(a):l.push({text:Resources.Clear,disabled:!(s&&s.value),subtle:!1,onClick:e.clearFilterSelection,id:"filter-clear-button"}),r.usesApplyMode()&&l.push({className:css(!i&&"bolt-filter-apply-button"),disabled:!r.hasChangesToApply(),text:Resources.Apply,primary:!0,subtle:!1,onClick:e.onApplyClick,id:"filter-apply-button"})}else r.hasChangesToReset()&&l.push(a),r.usesApplyMode()&&l.push({disabled:!r.hasChangesToApply(),text:Resources.Apply,primary:!0,subtle:!1,onClick:e.onDoneClick,id:"filter-done-button"});return React.createElement(ScreenSizeObserver,null,function(i){var a=i.screenSize===ScreenSize.xsmall;return React.createElement(Dropdown,{actions:l,calloutContentClassName:css("bolt-filter-callout",t&&"bolt-active-filter",a&&"absolute-fill"),className:css(e.props.className,"bolt-filter",o&&"bolt-filter-on"),dismissOnSelect:!1,enforceSingleSelect:null===t||void 0===t?void 0:t.enforceSingleSelect,filterByText:e.props.filterByText,onExpand:e.onExpandClick,onCollapse:e.clearActiveFilter,placeholder:o?Resources.FilterOn:Resources.Filter,ref:e.dropdown,items:e.props.items,userFilteredItems:t?e.props.userFilteredItems?e.props.userFilteredItems:t.items:[],renderExpandable:function(t){return React.createElement(DropdownExpandableButton,__assign({},t,{iconProps:{iconName:"Filter"},hideDropdownIcon:!0,renderSelectedItems:e.renderSelectedItems}))},renderCallout:function(i){return React.createElement(DropdownCalloutComponent,__assign({},i,{ariaLabel:e.props.title||Resources.FilterTitle,anchorElement:a?void 0:i.anchorElement,anchorOrigin:{horizontal:Location.start,vertical:Location.end},blurDismiss:!a,containerClassName:"bolt-filter-listbox-container",contentLocation:a?ContentLocation.Center:void 0,dropdownOrigin:{horizontal:Location.start,vertical:Location.start},enforceSingleSelect:null===t||void 0===t?void 0:t.enforceSingleSelect,filterText:e.filterText,ignoreMouseDown:!0,key:null===t||void 0===t?void 0:t.id,onFilterTextChanged:e.getOnFilterTextChanged(i),onFilterKeyDown:function(t){t&&!t.defaultPrevented&&t.which===KeyCode.enter&&e.props.filterItems.some(function(e){return"keyword-item"===e.id})&&e.filterText.value.length>0&&(r.setFilterItemState("keyword",{value:e.filterText.value}),e.filterText.value="")},showCloseButton:!0,title:t?React.createElement("div",{className:"flex-row flex-center bolt-filter-title-container"},!e.props.hideBackButton&&React.createElement(Button,{ariaLabel:Resources.Back,subtle:!0,className:"bolt-dropdown-header-button bolt-filter-back-button",iconProps:{iconName:"Back"},onClick:e.clearActiveFilter,tabIndex:-1}),t.title||t.name,n>1&&React.createElement(Pill,{className:"bolt-filter-selection-pill",size:PillSize.compact},n)):e.props.title||Resources.FilterTitle,renderBeforeContent:e.renderBeforeContent,ref:e.dropdownCallout}))},selection:e.selection,showFilterBox:!t||!(!1===t.showFilterBox),width:a?-1:e.props.width})})}))},t.defaultProps={width:FilterCalloutWidth},t}(React.Component);export{Filter};export function getKeywordFilterItem(e,t,r){void 0===r&&(r=[]);var i=new TimerManagement,o=function(t){e.setFilterItemState("keyword",{value:t}),e.usesApplyMode()||e.applyChanges()},l=t?i.debounce(o,t,{leading:!1,trailing:!0}):o;return{items:r,renderBeforeContent:function(t){var r=new ObservableValue(""),i=e.getFilterItemState("keyword");return r.value=i&&i.value?i.value:"",React.createElement(Observer,{filterExpression:{observableValue:e,filter:function(){var t=e.getFilterItemState("keyword");r.value=t&&t.value?t.value:""}}},function(){return React.createElement(TextField,{ariaLabel:Resources.Keyword,placeholder:Resources.SearchKeyword,autoFocus:!0,className:"bolt-filter-keyword-item",value:r,onChange:function(e,t){r.value=t,l(t)},onKeyDown:function(e){e.which===KeyCode.enter&&(t(),e.preventDefault())}})})},renderSelectedItems:function(){var t=e.getFilterItemState("keyword");return t&&t.value?React.createElement("span",null,'"'+t.value+'"'):null},enforceSingleSelect:!0,id:"keyword-item",filterItemKey:"keyword",name:Resources.Keyword,showFilterBox:!1}};export function getKeywordSearchResults(e){var t=[];return t.push({id:"keyword-header",text:Resources.Keyword,type:ListBoxItemType.Header,className:"bolt-filtered-header"}),t.push({id:e,text:format(Resources.KeywordSearchResult,e),groupId:"keyword-item"}),t};export function renderSelectedFilterItems(e){var t=e.some(function(e){return!!e.iconProps});return React.createElement(React.Fragment,null,e.map(function(r,i){return React.createElement("div",{className:css("bolt-filter-selected-item flex-row",!t&&"bolt-filter-selected-text-item"),key:r.id},renderListCell(r),!t&&i!==e.length-1&&React.createElement("span",null,", "))}))};