import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./TagPicker.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{Callout}from"../../Callout";import{FocusWithin}from"../../FocusWithin";import{FormItemContext}from"../../FormItem";import{Icon,IconSize}from"../../Icon";import{Measure}from"../../Measure";import{Observer}from"../../Observer";import{Pill}from"../../Pill";import{SuggestionsList}from"../../SuggestionsList";import{css,getSafeId,KeyCode}from"../../Util";import{Location}from"../../Utilities/Position";var TagPicker=function(e){function t(t){var n=e.call(this,t)||this;return n.inputElement=React.createRef(),n.outerElement=React.createRef(),n.textValue=new ObservableValue(""),n.suggestionsVisible=new ObservableValue(!1),n.selectedIndex=new ObservableValue(-1),n.selectableTags=new ObservableArray([]),n.clearTagPicker=function(){n.suggestionsVisible.value=!1,n.textValue.value="",n.selectedIndex.value=-1},n.suggestionsLoaded=function(){return-1===n.selectedIndex.value&&!ObservableLike.getValue(n.props.suggestionsLoading)&&n.inputElement.current&&""!==n.inputElement.current.value&&(n.updateIndexTimer&&window.cancelAnimationFrame(n.updateIndexTimer),n.updateIndexTimer=window.requestAnimationFrame(function(){n.selectedIndex.value=0})),!0},n.createGenericItem=function(e,t){var s=n.props.createDefaultItem&&n.props.createDefaultItem(e);if(!s||!t.some(function(e){return n.props.areTagsEqual(s,e)}))return s},n.onBlur=function(){if(!n.props.shouldBlurClear||n.props.shouldBlurClear()){var e=n.textValue.value;n.textValue.value="",n.selectableTags.value=[],n.props.onBlur&&n.props.onBlur(e),n.onSuggestionsDismiss()}},n.onOuterKeyDown=function(e){switch(e.which){case KeyCode.delete:case KeyCode.backspace:!e.isDefaultPrevented()&&n.selectableTags.value.length>0&&(n.props.onTagsRemoved&&n.props.onTagsRemoved(n.selectableTags.value),n.selectableTags.value=[],n.focusInput(),e.preventDefault())}},n.onKeyDown=function(e){var t=e.which,s=n.inputElement.current,a=n.suggestionsVisible.value,o=ObservableLike.getValue(n.props.suggestions);switch(t){case KeyCode.escape:n.onSuggestionsDismiss(),e.preventDefault();break;case KeyCode.tab:case KeyCode.enter:if(!e.shiftKey)if(a)n.completeSuggestion(),e.preventDefault();else if(n.props.createDefaultItem){var l=n.createGenericItem(n.textValue.value,ObservableLike.getValue(n.props.selectedTags));l&&(n.addItem(l),e.preventDefault())}break;case KeyCode.upArrow:a&&(n.selectedIndex.value=Math.max(0,n.selectedIndex.value-1),e.preventDefault());break;case KeyCode.downArrow:a?(n.selectedIndex.value=Math.min(o.length-1,n.selectedIndex.value+1),e.preventDefault()):""===n.textValue.value?(n.props.onEmptyInputFocus&&n.props.onEmptyInputFocus(),n.suggestionsVisible.value=!0,e.preventDefault()):(n.suggestionsVisible.value=!0,e.preventDefault());break;case KeyCode.rightArrow:a&&o&&o[n.selectedIndex.value]&&n.props.onSuggestionExpanded&&s&&s.value.length===s.selectionEnd&&(n.props.onSuggestionExpanded(o[n.selectedIndex.value]),e.preventDefault())}},n.onInputClick=function(e){n.props.onEmptyInputFocus&&""===n.textValue.value&&n.props.onEmptyInputFocus(),n.suggestionsVisible.value=!0,e&&e.preventDefault()},n.onInputChange=function(e){n.textValue.value=e.target.value,n.selectedIndex.value=-1,n.onResolveInput(e),e.persist(),e.preventDefault()},n.onResolveInput=function(e){var t=n.props.deliminator&&n.textValue.value.split(n.props.deliminator);n.props.onDelimitedSearch&&n.props.deliminator&&t&&t.length>1?n.props.onDelimitedSearch(n.textValue.value.split(n.props.deliminator)):(n.props.onSearchChanged(e.target.value),n.suggestionsVisible.value=!0)},n.onTagClicked=function(e,t){if(!e||!e.isDefaultPrevented()){var s=n.indexOfTag(t,n.selectableTags.value);if(!n.props.onTagsRemoved)return;s<0?n.selectableTags.push(t):n.selectableTags.splice(s,1),e&&e.preventDefault()}},n.onTagRemoved=function(e){var t=n.indexOfTag(e,n.selectableTags.value);t>=0&&n.selectableTags.splice(t,1),n.props.onTagRemoved(e),n.inputElement.current&&n.inputElement.current.focus()},n.onTagPickerSizeChanged=function(e,t){n.setState({width:e})},n.completeSuggestion=function(){var e=ObservableLike.getValue(n.props.suggestions)[n.selectedIndex.value];!!e&&n.addItem(e)},n.onSuggestionClick=function(e){n.addItem(e.item)},n.addItem=function(e){n.suggestionsVisible.value=!1,n.props.onTagAdded(e),n.textValue.value="",n.selectedIndex.value=-1,n.focusInput()},n.focusInput=function(){n.inputElement.current&&(n.inputElement.current.focus(),n.inputElement.current.select())},n.onSuggestionsDismiss=function(){n.suggestionsVisible.value=!1},n.indexOfTag=function(e,t){return t.findIndex(function(t){return n.props.areTagsEqual(t,e)})},n.state={width:296},n.timerManagement=new TimerManagement,n}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.ariaLabel,s=t.ariaLabelledBy,a=t.className,o=t.convertItemToPill,l=t.noResultsFoundText,i=t.onTagsRemoved,r=t.placeholderText,u=t.prefixIconProps,c=t.renderSuggestionItem,g=t.selectedTags,p=t.suggestions,d=t.suggestionsLoading,m=t.suggestionsLoadingText;return React.createElement(FocusWithin,{onBlur:this.onBlur},function(t){return React.createElement(React.Fragment,null,React.createElement(Observer,{suggestionsLoading:{observableValue:d,filter:e.suggestionsLoaded},suggestionsVisible:e.suggestionsVisible,selectedIndex:e.selectedIndex,selectableTags:e.selectableTags,selectedTags:g,suggestions:{observableValue:p,filter:e.suggestionsLoaded},textValue:e.textValue},function(l){var c=e.createGenericItem(e.textValue.value,l.suggestions.concat(l.selectedTags));return c&&l.suggestions.unshift(c),React.createElement(Measure,{onMeasure:e.onTagPickerSizeChanged},React.createElement("div",{className:css("bolt-tag-picker",(t.hasFocus||l.suggestionsVisible)&&"edit",a),ref:e.outerElement,onBlur:t.onBlur,onFocus:t.onFocus,onClick:e.focusInput},React.createElement("div",{className:"bolt-tag-picker-group flex-center flex-row flex-grow flex-wrap",onKeyDown:i&&e.onOuterKeyDown},0===l.selectedTags.length&&u?React.createElement(Icon,__assign({},u,{className:css(u.className,"bolt-tag-picker-prefix-icon")})):null,l.selectedTags.map(function(t,n){var s=o(t,n),a=e.indexOfTag(t,l.selectableTags);return React.createElement(Pill,__assign({},s,{key:getSafeId("bolt-tag-picker-pill"+n),className:css(s.className,"bolt-tag-picker-pill",i&&"bolt-tag-picker-pill-selectable",a>=0&&"active"),contentClassName:"text-ellipsis scroll-hidden",onClick:function(n){e.onTagClicked(n,t),s.onClick&&s.onClick(n)},onRemoveClick:function(n){e.onTagRemoved(t),n.preventDefault()}}),s.content)}),React.createElement(FormItemContext.Consumer,null,function(a){var o,i=0===l.selectedTags.length||t.hasFocus?r:void 0,u=!t.hasFocus&&l.selectedTags.length>0&&!l.suggestionsVisible;l.suggestionsVisible&&(o=getSafeId(-1===l.selectedIndex||l.suggestionsLoading?"sug-list-transition":l.suggestions&&l.suggestions.length?"sug-row-"+l.selectedIndex:"sug-list-no-results"));var c=l.suggestionsVisible?getSafeId("tag-picker-callout"):void 0;return React.createElement("div",{className:"bolt-tag-picker-add-icon-div flex-row flex-grow"},u&&React.createElement(Icon,{className:"bolt-tag-picker-add-icon cursor-pointer",iconName:"Add",size:IconSize.small}),React.createElement("input",{"aria-activedescendant":o,"aria-autocomplete":"list","aria-controls":c,"aria-expanded":l.suggestionsVisible,"aria-haspopup":"listbox","aria-label":n||r,"aria-labelledby":getSafeId(s||a.ariaLabelledById),className:css("bolt-tag-picker-input flex-row flex-grow scroll-hidden",u&&!i&&"hide-input"),onBlur:t.onBlur,onChange:e.onInputChange,onKeyDown:e.onKeyDown,onClick:e.onInputClick,placeholder:i,ref:e.inputElement,role:"combobox",type:"text",value:l.textValue}))}))))}),React.createElement(Observer,{suggestionsVisible:e.suggestionsVisible,suggestionsLoading:d,selectedIndex:e.selectedIndex,suggestions:p,textValue:e.textValue},function(n){return n.suggestionsVisible?React.createElement(Callout,{anchorElement:e.outerElement.current||void 0,anchorOrigin:{horizontal:Location.start,vertical:Location.end},calloutOrigin:{horizontal:Location.start,vertical:Location.start},contentClassName:"bolt-tag-picker-callout-content scroll-hidden",contentShadow:!0,id:"tag-picker-callout",role:"presentation"},React.createElement(SuggestionsList,{isLoading:n.suggestionsLoading,loadingText:m,onBlur:t.onBlur,onFocus:t.onFocus,noResultsFoundText:n.textValue?l:void 0,onSuggestionClicked:e.onSuggestionClick,renderSuggestion:c,selectedIndex:n.selectedIndex,suggestions:n.suggestions,width:e.state.width})):null}))})},t.prototype.componentDidMount=function(){this.onResolveInput=this.timerManagement.debounce(this.onResolveInput,this.props.onSearchChangedDebounceWait)},t.prototype.focus=function(){this.inputElement.current&&this.inputElement.current.focus()},t.defaultProps={onSearchChangedDebounceWait:250},t}(React.Component);export{TagPicker};