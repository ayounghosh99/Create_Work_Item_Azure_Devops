import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./IdentityPickerDropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{makeCancelable}from"../../Core/Util/Promise";import{FocusWithin}from"../../FocusWithin";import{Icon,IconSize}from"../../Icon";import{Measure}from"../../Measure";import{Observer}from"../../Observer";import{Persona,PersonaSize}from"../../Persona";import*as Resources from"../../Resources.IdentityPicker";import{TextField}from"../../TextField";import{css,KeyCode}from"../../Util";import{Location}from"../../Utilities/Position";import{IdentityPickerSuggestionItem}from"../IdentityPickerSuggestionsList/IdentityPickerSuggestionItem";import{IdentityPickerSuggestionsList}from"../IdentityPickerSuggestionsList/IdentityPickerSuggestionsList";import{shouldShowIdentityCard}from"./IdentityPickerUtils";var CustomIdentityPickerDropdown=function(e){function t(t){var n=e.call(this,t)||this;return n.focusWithin=React.createRef(),n.inputElement=React.createRef(),n.itemRefs={},n.openedIdentityCard=new ObservableValue(void 0),n.outerElement=React.createRef(),n.suggestionsLoading=new ObservableValue(!1),n.isEditing=new ObservableValue(!1),n.selectedIndex=new ObservableValue(-1),n.suggestions=new ObservableArray([]),n.onPickerDismiss=function(){n.props.onSuggestionsVisibleChanged(!1)},n.renderSuggestionItem=function(e){return React.createElement("div",{className:"flex-row flex-grow scroll-hidden",onKeyDown:n.onKeyDownSuggestionItem},React.createElement(IdentityPickerSuggestionItem,__assign({},e,{onOpenPersonaCard:n.openPersonaCard,ref:function(t){return n.itemRefs[e.item.entityId]=t},renderSuggestion:n.props.renderCustomIdentitySuggestion&&n.renderCustomSuggestionItem})))},n.renderCustomSuggestionItem=function(e){return n.props.renderCustomIdentitySuggestion&&n.props.renderCustomIdentitySuggestion(e.item)},n.renderPersonaCoin=function(e){return React.createElement(Observer,{selectedIdentity:n.props.value,isEditing:n.isEditing},function(t){return t.selectedIdentity&&!t.isEditing?React.createElement(Persona,{className:css("flex-row flex-center justify-center",e),identity:t.selectedIdentity,size:PersonaSize.size24}):React.createElement(Icon,{className:css("flex-row flex-center justify-center",e),iconName:"Contact",size:IconSize.medium})})},n.openPersonaCard=function(e){shouldShowIdentityCard(e)&&(n.openedIdentityCard.value=e)},n.closePersonaCard=function(){n.openedIdentityCard.value=void 0,n.inputElement.current&&n.inputElement.current.focus()},n.completeSuggestion=function(){var e;return n.suggestions.value.length>0&&ObservableLike.getValue(n.props.suggestionsVisible)&&-1!==n.selectedIndex.value?e=n.suggestions.value[n.selectedIndex.value]:(n.selectedIndex.value=-1,e=n.props.resolveUnrecognizedIdentity&&n.props.resolveUnrecognizedIdentity(ObservableLike.getValue(n.props.textValue))),n.selectedPersonaChanged(e),e&&n.props.onSuggestionsVisibleChanged(!1),Boolean(e)},n.onBlur=function(){n.props.onSuggestionsVisibleChanged(!1),n.openedIdentityCard.value||(""===ObservableLike.getValue(n.props.textValue)&&n.selectedPersonaChanged(),n.props.onBlur&&n.props.onBlur())},n.onClearClicked=function(e){n.clear(),e.preventDefault()},n.onClearKeyDown=function(e){e.which===KeyCode.enter&&(n.clear(),e.preventDefault())},n.clear=function(){var e;n.props.onClear&&n.props.onClear(),n.props.onChange(void 0),n.lastPickedIdentity=void 0,n.suggestions.value=[],null===(e=n.inputElement.current)||void 0===e||e.focus()},n.onClick=function(){""===ObservableLike.getValue(n.props.textValue)&&n.props.pickerProvider.onEmptyInputFocus||ObservableLike.getValue(n.props.value)&&0===n.suggestions.length?(n.updateSuggestionsList(n.props.pickerProvider.onEmptyInputFocus()),n.props.onSuggestionsVisibleChanged(!ObservableLike.getValue(n.props.suggestionsVisible))):n.props.onSuggestionsVisibleChanged(!ObservableLike.getValue(n.props.suggestionsVisible)),n.inputElement.current.select()},n.onFocus=function(e){var t=n.props.onFocus;""===ObservableLike.getValue(n.props.textValue)&&n.props.pickerProvider.onEmptyInputFocus&&!ObservableLike.getValue(n.props.suggestionsVisible)&&n.updateSuggestionsList(n.props.pickerProvider.onEmptyInputFocus()),t&&t(e)},n.onKeyDown=function(e){if(!e.isDefaultPrevented()){var t=e.which,o=ObservableLike.getValue(n.props.suggestionsVisible),s=n.inputElement.current&&n.inputElement.current.inputElement.current;switch(t){case KeyCode.escape:n.openedIdentityCard.value&&!(n.suggestions.value&&n.suggestions.value[n.selectedIndex.value])&&n.selectedPersonaChanged(),o&&(n.props.onSuggestionsVisibleChanged(!1),n.openedIdentityCard.value=void 0);break;case KeyCode.tab:case KeyCode.enter:!e.shiftKey&&o?n.completeSuggestion()&&(e.preventDefault(),e.stopPropagation()):o?n.completeSuggestion():t===KeyCode.enter&&s&&!s.value&&n.selectedPersonaChanged(void 0);break;case KeyCode.rightArrow:n.suggestions.value&&n.suggestions.value[n.selectedIndex.value]&&s&&s.value.length===s.selectionEnd&&(n.focusContactCardButton(n.suggestions.value[n.selectedIndex.value]),e.preventDefault());break;case KeyCode.upArrow:o&&n.suggestions.value&&(n.selectedIndex.value=Math.max(0,n.selectedIndex.value-1),n.forceUpdate(),e.preventDefault(),e.stopPropagation());break;case KeyCode.downArrow:o&&n.suggestions.value?(n.selectedIndex.value=Math.min(n.suggestions.value.length-1,n.selectedIndex.value+1),n.forceUpdate(),e.preventDefault(),e.stopPropagation()):n.props.onSuggestionsVisibleChanged(!0)}}},n.onKeyDownSuggestionItem=function(e){e.defaultPrevented||e.which!==KeyCode.leftArrow&&e.which!==KeyCode.escape&&e.which!==KeyCode.tab||n.inputElement.current&&(n.inputElement.current.focus(),e.preventDefault())},n.focusContactCardButton=function(e){n.itemRefs[e.entityId]&&n.itemRefs[e.entityId].focus()},n.onResolveSuggestions=function(e){var t=n.props.pickerProvider.onFilterIdentities(e,[]);null!==t&&n.updateSuggestionsList(t,e)},n.onSearchChange=function(e,t){if(0==t.length){var o=n.props.onClear;o&&o()}n.selectedIndex.value=-1,n.isEditing.value=!0,n.props.onInputChange(t),n.updateValue(t)},n.onSuggestionClick=function(e){n.selectedIndex.value=e.index,n.selectedPersonaChanged(e.item),n.props.onSuggestionsVisibleChanged(!1)},n.onTextFieldChanged=function(e,t){n.setState({width:Math.max(e,296)})},n.selectedPersonaChanged=function(e){n.lastPickedIdentity!==e&&(!!e&&!!n.props.pickerProvider.addIdentitiesToMRU&&n.props.pickerProvider.addIdentitiesToMRU([e]),!1!==n.props.onChange(e)?(n.props.onInputChange(e?e.displayName:""),n.lastPickedIdentity=e):(n.props.onInputChange(""),n.props.onChange(void 0),n.lastPickedIdentity=void 0)),n.isEditing.value=!1},n.updateValue=function(e){n.props.onSuggestionsVisibleChanged(!!e),n.cachedResults[e]?n.updateSuggestionsList(n.cachedResults[e],e):n.onResolveSuggestions(e)},n.cachedResults={},n.timerManagement=new TimerManagement,n.lastPickedIdentity=ObservableLike.getValue(t.value),n.state={width:296},n}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.autoFocus,o=t.disabled,s=t.editPlaceholder,i=void 0===s?Resources.IdentityPickerPlaceholderFocusText:s,r=t.placeholder,a=void 0===r?Resources.IdentityPickerPlaceholderText:r;return React.createElement(Observer,{suggestionsVisible:this.props.suggestionsVisible},function(t){return React.createElement(FocusWithin,{onBlur:e.onBlur,onFocus:e.onFocus,ref:e.focusWithin},function(s){return React.createElement(React.Fragment,null,React.createElement(Observer,{selectedIdentity:e.props.value,selectedIndex:e.selectedIndex,suggestionsLoading:e.suggestionsLoading,textValue:e.props.textValue},function(r){var u;t.suggestionsVisible&&(u=-1===r.selectedIndex||r.suggestionsLoading?"sug-list-transition":e.suggestions&&e.suggestions.length?"sug-row-"+r.selectedIndex:"sug-list-no-results");var l=t.suggestionsVisible?"tag-picker-callout":void 0,d=s.hasFocus||r.selectedIdentity?i:a;return React.createElement(Measure,{onMeasure:e.onTextFieldChanged},React.createElement("div",{className:"bolt-identitypickerdropdown flex-row flex-grow",ref:e.outerElement,onKeyDown:e.onKeyDown,role:"combobox","aria-expanded":t.suggestionsVisible},React.createElement(TextField,{ariaActiveDescendant:u,ariaAutoComplete:"list",ariaControls:l,autoFocus:n,ariaHasPopup:"listbox",ariaLabel:""===r.textValue?d:r.textValue,className:css(e.props.className,"bolt-identitypickerdropdown-textField flex-row flex-center",s.hasFocus&&"bolt-identitypickerdropdown-open"),containerClassName:"bolt-identitypickerdropdown-container flex-column flex-grow",onBlur:s.onBlur,onChange:e.onSearchChange,onClick:e.onClick,onFocus:s.onFocus,prefixIconProps:{render:e.renderPersonaCoin},placeholder:d,ref:e.inputElement,role:"textbox",suffixIconProps:r.textValue&&!o?{ariaHidden:"false",iconName:"Clear",className:"bolt-identity-picker-clearButton fontSize",onClick:e.onClearClicked,onKeyDown:e.onClearKeyDown,tabIndex:0}:void 0,value:r.textValue,disabled:o})))}),React.createElement(Observer,{openedIdentityCard:e.openedIdentityCard,selectedIndex:e.selectedIndex},function(n){return React.createElement(IdentityPickerSuggestionsList,{calloutProps:{anchorElement:e.outerElement.current,anchorOrigin:{horizontal:Location.start,vertical:Location.end},calloutOrigin:{horizontal:Location.start,vertical:Location.start},contentShadow:!0,id:"tag-picker-callout",onDismiss:e.onPickerDismiss,role:"presentation"},suggestionsVisible:t.suggestionsVisible||!!n.openedIdentityCard,isLoading:e.suggestionsLoading,onBlur:s.onBlur,onFocus:s.onFocus,onSuggestionClicked:e.onSuggestionClick,onClosePersonaCard:e.closePersonaCard,onDismiss:e.onPickerDismiss,onOpenPersonaCard:e.openPersonaCard,openedIdentityCard:n.openedIdentityCard,pickerProvider:e.props.pickerProvider,renderSuggestion:e.renderSuggestionItem,suggestions:e.suggestions,suggestionTarget:e.outerElement.current,selectedIndex:n.selectedIndex,width:e.state.width})}))})})},t.prototype.componentDidMount=function(){if(this.updateValue=this.timerManagement.debounce(this.updateValue,250),this.props.autoFocus){ObservableLike.getValue(this.props.textValue);this.props.pickerProvider.onEmptyInputFocus,this.updateSuggestionsList(this.props.pickerProvider.onEmptyInputFocus()),this.inputElement.current&&this.inputElement.current.select(),this.props.onSuggestionsVisibleChanged(!0)}this.setState({width:this.outerElement.current.clientWidth})},t.prototype.componentWillUnmount=function(){this.currentPromise&&this.currentPromise.cancel()},t.prototype.updateSuggestionsList=function(e,t){var n=this,o=e,s=e;if(Array.isArray(o))this.updateSuggestions(o,t);else if(s&&s.then){this.suggestionsLoading.value=!0;var i=this.currentPromise=makeCancelable(s);i.promise.then(function(e){i===n.currentPromise&&(n.updateSuggestions(e,t),t&&""!==t&&n.suggestions.value&&n.suggestions.value.length>0&&(n.cachedResults[t]=e),n.suggestionsLoading.value=!1)})}},t.prototype.setSuggestions=function(e,t){var n=this;this.suggestions.value=e,this.updateIndexTimer&&window.cancelAnimationFrame(this.updateIndexTimer),this.updateIndexTimer=window.requestAnimationFrame(function(){n.selectedIndex.value=t})},t.prototype.updateSuggestions=function(e,t){(void 0===t||this.inputElement.current&&ObservableLike.getValue(this.props.textValue)===t)&&this.setSuggestions(e,""===ObservableLike.getValue(this.props.textValue)?-1:0)},t}(React.Component);export{CustomIdentityPickerDropdown};