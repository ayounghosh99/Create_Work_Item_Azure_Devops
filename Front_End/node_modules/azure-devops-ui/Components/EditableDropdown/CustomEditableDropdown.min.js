import{__assign,__extends,__spreadArrays}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./EditableDropdown.css";import*as React from"react";import{ObservableArray,ObservableLike,ObservableValue}from"../../Core/Observable";import{TimerManagement}from"../../Core/TimerManagement";import{Dropdown,DropdownCallout,DropdownExpandableTextField,filterItems}from"../../Dropdown";import{renderListBoxCell}from"../../ListBox";import{Observer}from"../../Observer";import*as Resources from"../../Resources.Dropdown";import{css,KeyCode}from"../../Util";import{DropdownSelection}from"../../Utilities/DropdownSelection";import{EditableDropdownItemProvider}from"../../Utilities/EditableDropdownItemProvider";import{filterTreeItems,renderHighlightedText}from"../Dropdown/Dropdown";var CustomEditableDropdown=function(e){function t(t){var r=e.call(this,t)||this;if(r.dropdown=React.createRef(),r.listBox=React.createRef(),r.filteredIndexMap=new ObservableValue([]),r.filterMatches=[],r.collapse=function(){r.dropdown.current&&r.dropdown.current.collapse()},r.expand=function(){r.dropdown.current&&r.dropdown.current.expand()},r.renderItem=function(e,t,o,n){return r.wrapWithFocusedIndexObserver(e,t,o,n,function(e,t,o,n){var l=n,s=o,i=r.filterMatches[e];return!l.render&&i&&i.length&&(l.render=function(e,t,r,o){return renderHighlightedText(e,t,r,o,i)}),r.props.renderItem(e,t,s,l)})},r.wrapWithFocusedIndexObserver=function(e,t,o,n,l){return React.createElement(Observer,{focusedIndex:{observableValue:r.focusedIndex,filter:function(){var t=r.filteredIndexMap.value[e];return t===r.focusedIndex.value||t===r.previousFocusedIndex}},key:"focused-observer-"+e+"-"+t},function(){var s=r.filteredIndexMap.value[e]===r.focusedIndex.value?__assign(__assign({},n),{className:css(n.className,"bolt-editable-dropdown-focused-item")}):__assign({},n);return l(e,t,o,s)})},r.onCollapse=function(){var e=r.props,t=e.allowFreeform,o=e.autoAccept,n=e.onCollapse,l=e.onTextChange,s=e.onValueChange,i=e.showTree,a=e.text;if(n&&n(),!r.selectedItemInList){var d=r.itemProvider.value.findIndex(function(e,t){return r.selection.selectable(t)&&e.text===ObservableLike.getValue(a||"")});d>-1&&r.selectIndex(d)}var c=r.itemProvider.length-1;if(!t||r.selection.value.length&&r.selection.value[0].beginIndex!==c&&r.selectedItemInList||!r.itemProvider.hasExtraItem){if(i&&r.lastSelectedItem)s&&s(r.lastSelectedItem);else if(r.selection.value.length){var u=r.itemProvider.value[r.selection.value[0].beginIndex];s&&s(u)}}else{if(o||r.selectedItemInList||r.selectedFreeform){var p=r.itemProvider.value[c].id;s&&s({id:p,text:p})}r.selectedFreeform=!1,r.selection.clear()}l&&l(null,""),r.isExpanded=!1,r.selectedItemInList=!1,r.lastSelectedItem=void 0},r.onItemsChange=function(e,t){"change"!==t&&r.filterItems()},r.onSelect=function(e,t){r.selectedItemInList=!0,r.lastSelectedItem=t},r.renderExpandable=function(e){return React.createElement(Observer,{focusedIndex:r.focusedIndex,selectedText:r.props.selectedText,text:r.props.text},function(t){var o,n=r.props,l=n.allowTextSelection,s=n.onTextChange,i=t.focusedIndex,a=t.selectedText,d=t.text;i>-1&&r.itemProvider.value[i]&&(o=r.itemProvider.value[i].id);var c=l&&a&&!r.isExpanded?a:d,u=__assign(__assign({},e),{ariaActiveDescendant:o,editable:!0,showPrefix:!d,blurDismiss:!0,onChange:s,onKeyDown:r.onKeyDown,value:c});return r.props.renderExpandable(u)})},r.renderCallout=function(e){var t=__assign(__assign({},e),{focusOnMount:!1,excludeTabStop:!0,excludeFocusZone:!0,ignoreMouseDown:!0,listBoxRef:r.listBox});return r.props.renderCallout(t)},r.onExpand=function(){if(r.props.onExpand&&r.props.onExpand(),r.props.filterItems){var e=r.props.filterItems("",r.itemProvider.value),t=r.updateFilteredIndexMap(e.filteredIndexMap);r.filteredItems.value=e.filteredItems,r.focusItem(t)}else{r.filteredItems.value=r.itemProvider.value;var o=r.updateFilteredIndexMap(r.filteredItems.value.map(function(e,t){return t}));r.focusItem(o)}r.isExpanded=!0},r.onValueChange=function(){var e=ObservableLike.getValue(r.props.text||"");return r.props.allowFreeform&&(r.itemProvider.hasExtraItem&&r.filteredItems.pop(),r.itemProvider.setTextValue(e)),r.filterItems(),!1},r.filterItems=function(){var e,t=r.itemProvider.value,o=ObservableLike.getValue(r.props.text||"");e=r.props.filterItems?r.props.filterItems(o,t):o?r.props.showTree?filterTreeItems(t,o,[],r.props.filterItem):filterItems(t,o,[],r.props.filterItem):{filteredItems:t,filteredIndexMap:t.map(function(e,t){return t}),filterMatches:[]},r.filterMatches=e.filterMatches;var n=r.updateFilteredIndexMap(e.filteredIndexMap);r.filteredItems.value=e.filteredItems,r.focusItem(n)},r.onKeyDown=function(e){var t=e.which,o=r.isExpanded;switch(t){case KeyCode.escape:r.collapse(),e.preventDefault();break;case KeyCode.enter:r.isExpanded||(r.expand(),e.preventDefault());case KeyCode.tab:o&&!e.shiftKey&&(r.filteredItems.length||r.props.allowFreeform)&&(r.focusedIndex.value>=0?r.selectIndex(r.focusedIndex.value):r.selectedFreeform=!0,r.collapse(),e.preventDefault());break;case KeyCode.upArrow:r.isExpanded&&(r.focusPreviousItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(r.focusedIndex.value),{block:"nearest"})),e.preventDefault();break;case KeyCode.downArrow:r.isExpanded?(r.focusNextItem(),r.listBox.current&&r.listBox.current.scrollIntoView(r.filteredIndexMap.value.indexOf(r.focusedIndex.value),{block:"nearest"})):r.isExpanded||r.expand(),e.preventDefault();break;case KeyCode.delete:case KeyCode.backspace:r.props.allowClear&&!ObservableLike.getValue(r.props.text||"")&&(r.selection.clear(),r.props.onValueChange&&r.props.onValueChange());break;default:r.expand()}},r.selection=t.selection||new DropdownSelection,r.itemProvider=new EditableDropdownItemProvider(t.items,r.selection),r.filteredItems=new ObservableArray(__spreadArrays(r.itemProvider.value)),r.focusedIndex=new ObservableValue(-1),r.previousFocusedIndex=-1,r.timerManagement=new TimerManagement,r.filteredIndexMap.value=r.itemProvider.value.map(function(e,t){return t}),r.props.selectedText){var o=ObservableLike.getValue(r.props.selectedText);if(o){var n=r.itemProvider.value.findIndex(function(e){return e.text===o});n>-1&&r.selection.select(n)}}return r.props.columns&&(r.columns=r.props.columns.map(function(e){return __assign(__assign({},e),{renderCell:function(t,o,n,l){return r.wrapWithFocusedIndexObserver(t,o,n,l,e.renderCell)}})})),r}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.props,r=t.allowTextSelection,o=t.ariaLabel,n=t.calloutContentClassName,l=t.className,s=t.disabled,i=t.filterByText,a=t.getUnselectableRanges,d=t.noItemsText,c=t.selectedText,u=t.showTree,p=t.text;return React.createElement(Observer,{text:{observableValue:p,filter:this.onValueChange},items:{observableValue:this.itemProvider,filter:this.onItemsChange},selection:this.selection,selectedText:c},function(t){var c=e.props.placeholder;if(!r)if(t.selectedText)c=t.selectedText;else if(t.selection.length){var p=t.selection[0].beginIndex;c=e.itemProvider.value[p].text}return React.createElement(Dropdown,{ariaLabel:o,calloutContentClassName:n,className:css("bolt-editable-dropdown",(t.selection.length>0||!!t.selectedText)&&"bolt-editable-dropdown-with-selection",l),columns:e.columns,disabled:s,getUnselectableRanges:a,filterByText:i,items:e.itemProvider,noItemsText:d||Resources.NoItemsFound,onCollapse:e.onCollapse,onExpand:e.onExpand,onSelect:e.onSelect,placeholder:c,ref:e.dropdown,renderCallout:e.renderCallout,renderExpandable:e.renderExpandable,renderItem:e.renderItem,selection:e.selection,showFilterBox:!1,showTree:u,userFilteredItems:e.filteredItems,userFilteredItemsIndexMap:e.filteredIndexMap})})},t.prototype.componentDidMount=function(){this.props.filterThrottleWait&&(this.filterItems=this.timerManagement.debounce(this.filterItems,this.props.filterThrottleWait))},t.prototype.focus=function(){this.dropdown.current&&this.dropdown.current.focus()},t.prototype.selectIndex=function(e){e>-1&&(this.selection.select(e),this.selectedItemInList=!0)},t.prototype.focusItem=function(e){void 0!==e&&e>-1&&(this.previousFocusedIndex=this.focusedIndex.value,this.focusedIndex.value=e)},t.prototype.updateFilteredIndexMap=function(e){var t=this,r=this.filteredIndexMap.value.indexOf(this.focusedIndex.value);this.filteredIndexMap.value=e;var o=e[r];return(!o||o<0||!this.selection.selectable(o)||-1===this.filteredIndexMap.value.indexOf(o))&&(o=this.filteredIndexMap.value.find(function(e){return t.selection.selectable(e)})),o},t.prototype.focusNextItem=function(){for(var e,t=this.filteredIndexMap.value.indexOf(this.focusedIndex.value)+1;t<this.filteredIndexMap.value.length;t++)if(this.selection.selectable(this.filteredIndexMap.value[t])){e=this.filteredIndexMap.value[t];break}this.focusItem(e)},t.prototype.focusPreviousItem=function(){for(var e,t=this.filteredIndexMap.value.indexOf(this.focusedIndex.value)-1;t>=0;t--)if(this.selection.selectable(this.filteredIndexMap.value[t])){e=this.filteredIndexMap.value[t];break}this.focusItem(e)},t.defaultProps={allowClear:!0,autoAccept:!0,renderExpandable:DropdownExpandableTextField,renderCallout:DropdownCallout,renderItem:renderListBoxCell},t}(React.Component);export{CustomEditableDropdown};