function getAttributeAsNumber(e,t){var o=e.getAttribute(t);return o?parseInt(o,10):-1}import{__assign,__extends}from"tslib";import"../../CommonImports";import"../../Core/core.css";import"./List.css";import"./ListDropIndicator.css";import*as React from"react";import{ObservableLike,ObservableValue}from"../../Core/Observable";import{FocusWithin}from"../../FocusWithin";import{FocusZone,FocusZoneContext,FocusZoneDirection}from"../../FocusZone";import{IntersectionContext}from"../../Intersection";import{Observer}from"../../Observer";import{css,eventTargetContainsNode,getSafeId,KeyCode}from"../../Util";import{EventDispatch}from"../../Utilities/Dispatch";var FixedHeightList=function(e){function t(t){var o=e.call(this,t)||this;o.intersectionElements={},o.bodyElement=React.createRef(),o.listElement=React.createRef(),o.scrollToIndex=-1,o.scrollToOptions=void 0,o.selectOnFocus=!0,o.focusIndex=new ObservableValue(-1),o.pivotIndex=-1,o.onBlur=function(){o.focusIndex.value=-1},o.onClick=function(e){if(o.onDispatch(e),!e.defaultPrevented&&o.listElement.current){var t=rowFromEvent(e),i=t.cellElement,r=t.rowIndex;if(!i){var s=ObservableLike.getValue(o.state.rows[r]);if(r>=0&&s){var n={data:s,index:r};o.props.selectRowOnClick&&o.processSelectionEvent(e,n),o.props.singleClickActivation&&o.rowActivated(e,n)}}}},o.onDispatch=function(e){o.state.eventDispatch.dispatchEvent(e)},o.onDoubleClick=function(e){if(o.onDispatch(e),!e.defaultPrevented&&!o.props.singleClickActivation){var t=rowFromEvent(e).rowIndex,i=ObservableLike.getValue(o.state.rows[t]);t>=0&&i&&o.rowActivated(e,{data:i,index:t})}},o.onFocusBody=function(e){if(o.selectOnFocus){var t=o.props.selection;if(!t||t.selectOnFocus){var i=o.focusIndex.value;if(i>=0){var r=ObservableLike.getValue(o.state.rows[i]);r&&o.processSelectionEvent(e,{data:r,index:i})}}o.selectOnFocus=!1}},o.onFocusItem=function(e,t){var i=o.focusIndex;if(i.value!==e){o.focusRow(e,2),i.value>=0?delete o.state.renderedRows[i.value]:void 0!==o.props.defaultTabbableRow&&delete o.state.renderedRows[o.props.defaultTabbableRow],delete o.state.renderedRows[e],o.focusIndex.value=e;var r=ObservableLike.getValue(o.state.rows[e]);r&&o.rowFocused(t,{data:r,index:e})}},o.onKeyDown=function(e){if(o.onDispatch(e),!e.defaultPrevented){var t=e.target.nodeName;if("INPUT"===t||"TEXTAREA"===t)return;var i=o.focusIndex,r=ObservableLike.getValue(o.state.rows[i.value]);if(r)if(e.which===KeyCode.enter)i.value>=0&&!eventTargetContainsNode(e,["A"])&&o.rowActivated(e,{data:r,index:i.value});else if(e.which===KeyCode.space)o.processSelectionEvent(e,{data:r,index:i.value}),e.preventDefault();else if(e.which===KeyCode.upArrow||e.which===KeyCode.downArrow){var s=o.props.selection;s&&(!s.selectOnFocus||!e.shiftKey&&e.ctrlKey)||(e.persist(),window.setTimeout(function(){o.focusIndex.value!=i.value&&o.processSelectionEvent(e,{data:r,index:o.focusIndex.value})},0))}else e.which===KeyCode.pageDown?(o.focusRow(Math.min(i.value+o.props.pageSize,o.state.rowCount-1),1),e.preventDefault()):e.which===KeyCode.pageUp?(o.focusRow(Math.max(i.value-o.props.pageSize,0),-1),e.preventDefault()):e.which===KeyCode.home?(o.focusRow(0,1),e.preventDefault()):e.which===KeyCode.end&&(o.focusRow(o.state.rowCount-1,-1),e.preventDefault())}},o.onIntersect=function(e){var t=o.context.root.scrollTop,i=o.state.rowCount,r=o.state,s=r.firstMaterialized,n=r.lastMaterialized,a=o.state,l=a.rowHeight,c=a.rowProportion;if((t===o.state.scrollTop||!e.length)&&o.listElement.current&&o.bodyElement.current){var d=o.context.root.getBoundingClientRect(),h=Math.max(0,t+o.context.root.offsetTop-o.listElement.current.offsetTop),u=Math.max(0,Math.min(i-1,Math.floor(h/(l*c)))),p=Math.min(i-1,u+Math.ceil(d.height/l));h+(p-u)*l>o.state.maxHeight&&(p=i-1,u=Math.max(0,p-Math.ceil(d.height/l))),u===s&&p===n&&l===o.state.rowHeight&&t===o.state.scrollTop&&h===o.state.scrollTopRect||o.setState({firstMaterialized:u,lastMaterialized:p,rowHeight:l,scrollTop:t,scrollTopRect:h})}},o.onMouseDownBody=function(e){o.selectOnFocus=!1};var i=t.itemProvider.length;return o.state={eventDispatch:t.eventDispatch||new EventDispatch,firstMaterialized:0,itemProvider:t.itemProvider,lastMaterialized:0,maxHeight:o.props.maxHeight||1e6,focusRows:{},renderedRows:{},rowCount:i,rowHeight:t.rowHeight||0,rowProportion:t.rowHeight&&t.maxHeight?Math.min(1,t.maxHeight/(t.rowHeight*i)):1,rows:{},scrollTop:0,scrollTopRect:0},o}return __extends(t,e),t.getDerivedStateFromProps=function(e,t){var o=e.itemProvider.length,i=t.firstMaterialized,r=t.lastMaterialized;o!==t.rowCount&&(i=Math.max(0,Math.min(t.firstMaterialized,o)),r=Math.max(i,Math.min(t.lastMaterialized+(t.lastMaterialized===t.rowCount-1?e.pageSize:0),o-1)));var s={firstMaterialized:i,itemProvider:e.itemProvider,lastMaterialized:r,rowCount:o,rowProportion:Math.min(1,t.maxHeight/(t.rowHeight*o))};return e.itemProvider!==t.itemProvider&&(s.renderedRows={},s.rows={}),s},t.prototype.render=function(){var e=this,t=this.props,o=t.className,i=t.focuszoneProps,r=t.id,s=t.width,n=this.state,a=n.firstMaterialized,l=n.lastMaterialized,c=n.maxHeight,d=n.rowCount,h=n.rowHeight,u=this.props.role?this.props.role:this.props.selection?"listbox":"list",p=[],f=Math.max(0,this.focusIndex.value-3),v=Math.min(d,this.focusIndex.value+3);if(p.push(this.renderIntersectionBounds(!0)),-1!==this.focusIndex.value&&f<a)for(m=f;m<=Math.min(v,a-1);m++)p.push(this.renderRow(m,!1));for(m=a;m<=l;m++)p.push(this.renderRow(m,!0));if(-1!==this.focusIndex.value&&v>l&&l>0)for(var m=Math.max(f,l+1);m<=v;m++)p.push(this.renderRow(m,!1));p.push(this.renderIntersectionBounds(!1));var w=Math.min(c,h*this.state.rowCount),x=React.createElement("div",{"aria-label":this.props.ariaLabel,className:css(o,"bolt-fixed-height-list relative"),id:getSafeId(r),onBlur:this.onBlur,onClick:this.onClick,onDoubleClick:this.onDoubleClick,onDragEnd:this.onDispatch,onDragEnter:this.onDispatch,onDragExit:this.onDispatch,onDragOver:this.onDispatch,onDragStart:this.onDispatch,onDrop:this.onDispatch,onKeyUp:this.onDispatch,onMouseDown:this.onDispatch,onTouchStart:this.onDispatch,ref:this.listElement,role:u,style:{width:s,height:w}},React.createElement("div",{className:"relative",onFocus:this.onFocusBody,onKeyDown:this.onKeyDown,onMouseDown:this.onMouseDownBody,ref:this.bodyElement,style:{width:s,height:w}},p));return x=React.createElement(FocusZone,__assign({direction:FocusZoneDirection.Vertical,skipHiddenCheck:!0},i),x),React.createElement(Observer,{itemProvider:{filter:function(t,o){e.props.selection&&e.props.selection.onItemsChanged(t,o);var i={renderedRows:{},focusRows:{},rows:{}};if(-1!==e.state.rowCount){var r=(t.addedItems?t.addedItems.length:0)-(t.removedItems?t.removedItems.length:0);r&&(i.rowCount=e.state.rowCount+r,i.firstMaterialized=Math.max(0,Math.min(e.state.firstMaterialized,i.rowCount-1)),i.lastMaterialized=Math.max(i.firstMaterialized,Math.min(e.state.lastMaterialized+(t.index>=e.state.firstMaterialized&&t.index<=e.state.lastMaterialized+1?r:0),i.rowCount-1)))}return e.setState(i),!1},observableValue:this.props.itemProvider}},function(){return x})},t.prototype.componentDidMount=function(){this.onIntersect([]),this.context.register(this.onIntersect)},t.prototype.componentDidUpdate=function(e,t){var o=this.scrollToIndex,i=this.onScrollComplete;if(this.state.rowCount!==t.rowCount&&this.onIntersect([]),-1!==o&&this.state.rowHeight){var r=this.bodyElement.current,s=this.state,n=s.firstMaterialized,a=s.lastMaterialized;if(o>=n&&o<=a&&r)for(var l=0;l<r.children.length;l++){var c=r.children[l];if(rowFromElement(c).rowIndex===o){c.scrollIntoView(this.scrollToOptions);break}}this.onScrollComplete=void 0,this.scrollToIndex=-1,this.scrollToOptions=void 0,i&&i(o)}},t.prototype.componentWillUnmount=function(){this.context.unregister(this.onIntersect)},t.prototype.getFocusIndex=function(){return this.focusIndex.value},t.prototype.getStats=function(){return{firstMaterialized:this.state.firstMaterialized,lastMaterialized:this.state.lastMaterialized}},t.prototype.scrollIntoView=function(e,t,o){this.props.pageSize;var i=this.state,r=i.firstMaterialized,s=i.lastMaterialized,n=i.rowCount;if(e>=0&&e<this.state.rowCount){var a=this.bodyElement.current;if(e>=r&&e<=s&&a){for(var l=0;l<a.children.length;l++){var c=a.children[l];if(rowFromElement(c).rowIndex===e){c.scrollIntoView(t);break}}o&&o(e)}else this.onScrollComplete&&this.onScrollComplete(-1),this.onScrollComplete=o,this.scrollToIndex=e,this.scrollToOptions=t,this.setState({firstMaterialized:Math.max(0,e-Math.floor((s-r)/2)),lastMaterialized:Math.min(n-1,Math.ceil(e+(s-r)/2))})}},t.prototype.focusRow=function(e,t){var o=this;this.scrollIntoView(e,{block:"nearest"},function(i){if(i===e&&o.bodyElement.current){var r=o.bodyElement.current.querySelector("[data-row-index='"+i+"']");if(r)if(r.getAttribute("tabindex"))r.focus();else{var s=Math.min(o.state.rowCount-1,Math.max(0,i+t));s!==i?o.focusRow(s,t):s!==o.focusIndex.value&&o.focusRow(s,-t)}}})},t.prototype.processSelectionEvent=function(e,t){var o=this.props.selection;if(!o||o.selectable(t.index)){var i=!1,r=!0;if(o){var s=t.index;i=o.selected(s),this.pivotIndex>=0&&e.shiftKey&&o.multiSelect?o.select(Math.min(this.pivotIndex,s),Math.abs(this.pivotIndex-s)+1,e.ctrlKey||e.metaKey):(e.ctrlKey||e.metaKey||o.alwaysMerge)&&o.multiSelect?(o.toggle(s,!0),r=!1):o.select(s,1,!1),e.shiftKey||(this.pivotIndex=s)}i!==r&&this.rowSelected(e,t)}},t.prototype.renderLoadingRow=function(e,t){return React.createElement("div",{className:"bolt-list-row-loading"},React.createElement("div",{className:"shimmer shimmer-line",style:{width:80*Math.random()+20+"%"}},"Â "))},t.prototype.renderIntersectionBounds=function(e){var t=this,o=this.state,i=o.firstMaterialized,r=o.lastMaterialized,s=o.rowHeight,n=o.rowProportion,a=e?"topobserv":"bottomobserv",l=0;return i*s*n+(r-i)*s>this.state.maxHeight?e?(l=this.state.maxHeight,l-=(r-i)*s*n+s,l--):l=this.state.maxHeight-1:l=e?i*s*n-1:i*s*n+(1+r-i)*s+1,React.createElement("div",{"aria-hidden":"true",className:"bolt-list-row-spacer invisible absolute",key:a,ref:function(e){var o=t.intersectionElements[a];e?o!==e&&(o&&t.context.unobserve(e),t.context.observe(e),t.intersectionElements[a]=e):o&&(t.context.unobserve(o),delete t.intersectionElements[a])},role:"presentation",style:{top:l+"px",height:"1px"}})},t.prototype.renderRow=function(e,t){var o=this,i=this.props.itemProvider,r=this.state,s=r.focusRows,n=r.renderedRows,a=r.firstMaterialized,l=r.lastMaterialized,c=(r.rowHeight,r.rowProportion),d=r.rows,h=t?n[e]:s[e];if(!h||1!==c){var u=d[e];if(u||(u=i.getItem?i.getItem(e):i.value[e]),!u)return null;d[e]=u;var p=this.props.selection,f=void 0;p&&(f={observableValue:p,filter:function(t){for(var o=0,i=t;o<i.length;o++){var r=i[o];if(e>=r.beginIndex&&e<=r.endIndex)return!0}return!1}});var v=function(t){o.onFocusItem(e,t)};h=React.createElement(Observer,{item:u,key:e,selection:f,focusIndex:this.focusIndex},function(t){var i,r=o.props,s=r.renderRow,n=r.renderLoadingRow,d=o.state,h=d.rowHeight,p=d.rowCount,f=ObservableLike.getValue(u),m={ariaBusy:!t.item,ariaRowOffset:1,data:f,eventDispatch:o.state.eventDispatch,itemProvider:o.props.itemProvider,listProps:o.props,onFocusItem:o.onFocusItem,singleClickActivation:o.props.onActivate&&o.props.singleClickActivation};i=t.item?s(e,t.item,m):n?n(e,m):o.renderLoadingRow(e,m);var w=0,x=0;return e>=a&&e<=l&&(x=h),a*h*c+(l-a)*h>o.state.maxHeight?(w=o.state.maxHeight,w-=(p-l)*h*c,w-=(l-e)*h):0===x?w=e*h*c:(w=a*h*c,w+=(e-a)*h),React.createElement(FocusWithin,{onFocus:v},function(t){return React.createElement(FocusZoneContext.Consumer,null,function(r){return React.createElement(FocusZone,{direction:FocusZoneDirection.Horizontal},React.createElement("div",{className:css("bolt-fixed-height-list-row scroll-hidden absolute",o.focusIndex.value===e&&"focused"),style:{height:x+"px",top:w+"px"},"data-focuszone":r.focuszoneId,"data-row-index":e,tabIndex:0===e?0:-1,onBlur:t.onBlur,onFocus:t.onFocus},i))})})}),t?this.state.renderedRows[e]=h:this.state.focusRows[e]=h}return h},t.prototype.rowActivated=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"activate"),this.props.onActivate&&this.props.onActivate(e,t)},t.prototype.rowSelected=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"select"),this.props.onSelect&&this.props.onSelect(e,t)},t.prototype.rowFocused=function(e,t){this.state.eventDispatch.dispatchEvent(e,t,"focus"),this.props.onFocus&&this.props.onFocus(e,t)},t.contextType=IntersectionContext,t.defaultProps={defaultTabbableRow:0,focuszoneProps:{direction:FocusZoneDirection.Vertical},maxHeight:1e6},t}(React.Component);export{FixedHeightList};export function rowFromElement(e){for(var t,o=-1;e;){if(-1!==(t=getAttributeAsNumber(e,"data-row-index"))){o=t;break}if(e.classList.contains("bolt-fixed-height-list")){e=null;break}e=e.parentElement}return{cellElement:null,cellIndex:-1,rowElement:e,rowIndex:o}};export function rowFromEvent(e){return rowFromElement(e.target)};